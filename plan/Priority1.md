# Priority 1 — Wire the Route Pages

These three changes connect the already-built socket infrastructure, hooks, and components to the actual browser route pages. The application cannot be played until all three are complete.

**Prerequisite:** `pnpm dev` is running (client on :3000, server on :3001, Redis on :6379).

---

## Step 1 — Fix the Home Page

**File:** `client/app/page.tsx`

The current page uses `<Link href="/lobby/new">` which navigates to a dead route instead of creating a real room via socket.

| Task     | Description                                                                                                                                                                                                     | Test                                                                                                                                                     | Spec                                                                                                      |
| -------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------- |
| P1.S1.T1 | Convert `app/page.tsx` from a Server Component to a Client Component (`'use client'`). Remove the `Link` imports. Add `useRouter` from `next/navigation`.                                                       | File compiles without TypeScript errors.                                                                                                                 | [P1B.S1.T3](Phase1B.md#step-1b1--nextjs-app-shell)                                                        |
| P1.S1.T2 | Add a name-entry state (`playerName: string`) and a loading state (`creating: boolean`) to the home page. Render a text input for the player's name above the "Create Game" button.                             | The input renders at `localhost:3000`; typing into it updates local state.                                                                               | [P1B.S7.T7](Phase1B.md#step-1b7--lobby-ui)                                                                |
| P1.S1.T3 | Replace the `<Link href="/lobby/new">` with a `<button>` that calls `createRoom(playerName)` from `useGameSocket()`. While awaiting, set `creating = true` to disable the button.                               | Clicking "Create Game" with a name: the button goes disabled briefly, then the browser navigates to `/lobby/<ROOMCODE>` (a real 6-char code, not "new"). | [P2.S3.T1](Phase2.md#step-23--lobby--room-management), [P1B.S1.T3](Phase1B.md#step-1b1--nextjs-app-shell) |
| P1.S1.T4 | On `createRoom` success navigate to `/lobby/${roomCode}`. On failure display an inline error message below the button (not an alert).                                                                           | Simulate a server error (stop the server process): the error message appears inline on the page.                                                         | [P2.S3.T1](Phase2.md#step-23--lobby--room-management)                                                     |
| P1.S1.T5 | Replace `<Link href="/lobby/join">` with a button that navigates to `/lobby/join` (a new page, see Step 2 below, or use a query param). For now navigate to `/lobby/join`. Disable it if `playerName` is empty. | "Join Game" button is disabled when the name field is empty; enabled once a name is typed.                                                               | [P1B.S7.T2](Phase1B.md#step-1b7--lobby-ui)                                                                |

---

## Step 2 — Wire the Lobby Page

**File:** `client/app/lobby/[roomCode]/page.tsx`

The current file is a 10-line placeholder. It must handle three URL states:

- `roomCode === 'join'` → show `JoinGameForm`
- Guest arriving via a shared link → show `NameEntryModal` then join
- Host who just created a room → show `WaitingRoom`

| Task     | Description                                                                                                                                                                                                   | Test                                                                                                                                                | Spec                                                                                              |
| -------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------- |
| P1.S2.T1 | Convert `app/lobby/[roomCode]/page.tsx` to a Client Component. Wrap its contents in `<GameStateProvider>` (from `useGameState.tsx`) so all child components have socket context.                              | The page renders without "useGameState must be used within a GameStateProvider" error.                                                              | [P2.S4.T5](Phase2.md#step-24--game-state-synchronization)                                         |
| P1.S2.T2 | When `roomCode === 'join'`, render the `<JoinGameForm>` component (from `Lobby.tsx`). On form submit, call `joinRoom(code, playerName)` and navigate to `/lobby/${code}`.                                     | Navigate to `/lobby/join` → form renders. Submit with a valid room code → browser navigates to `/lobby/<CODE>`.                                     | [P1B.S7.T2](Phase1B.md#step-1b7--lobby-ui), [P2.S3.T3](Phase2.md#step-23--lobby--room-management) |
| P1.S2.T3 | When `roomCode` is a real code and the local player is not yet in the room (no `playerId` in context), show `<NameEntryModal>`. On submit call `joinRoom(roomCode, name)` and store the player in context.    | Open `/lobby/ABCD12` in a fresh browser tab → the name/token modal appears.                                                                         | [P1B.S7.T7](Phase1B.md#step-1b7--lobby-ui), [P2.S3.T3](Phase2.md#step-23--lobby--room-management) |
| P1.S2.T4 | Once the player is in the room (context has `room` data), render `<WaitingRoom roomCode={roomCode} players={...} isHost={...} />` from `Lobby.tsx`. Derive `isHost` by comparing `playerId` to `room.hostId`. | After creating a game, the waiting room renders with the room code displayed in `[data-testid="room-code"]` and the host's name in the player list. | [P1B.S7.T3](Phase1B.md#step-1b7--lobby-ui), [P2.S3.T3](Phase2.md#step-23--lobby--room-management) |
| P1.S2.T5 | Wire the `<TokenSelector>` inside `WaitingRoom` to call `selectToken(roomCode, token)`. Update player's token in the player list live as the `playerUpdated` socket event fires.                              | Select a token → the token icon updates immediately in the player list for all connected browser tabs.                                              | [P2.S3.T5](Phase2.md#step-23--lobby--room-management), [P1B.S7.T4](Phase1B.md#step-1b7--lobby-ui) |
| P1.S2.T6 | Wire the host's "Start Game" button to call `startGame(roomCode)`. On `gameStarted` event (dispatched by `GameStateProvider`), navigate all clients to `/game/${gameState.gameId}`.                           | With 2 players in the lobby, host clicks Start → both browser tabs navigate to the game page simultaneously.                                        | [P2.S3.T7](Phase2.md#step-23--lobby--room-management), [P1B.S7.T6](Phase1B.md#step-1b7--lobby-ui) |
| P1.S2.T7 | Show the `<ReconnectionOverlay>` (from `connection/`) when the socket disconnects while on the lobby page. Hide it on reconnect.                                                                              | Kill the server process while on the lobby page → the reconnecting overlay appears. Restart the server → overlay disappears.                        | [P2.S5.T6](Phase2.md#step-25--reconnection-handling)                                              |
| P1.S2.T8 | Display a `<ConnectionError>` component if the join/create call returns `{ ok: false }` (e.g. room full, game already started, invalid code).                                                                 | Try joining a non-existent room code → the error message from the server renders on screen.                                                         | [P2.S3.T4](Phase2.md#step-23--lobby--room-management)                                             |

---

## Step 3 — Wire the Game Page

**File:** `client/app/game/[gameId]/page.tsx`

The current file is a 10-line placeholder. It must mount the full game UI inside a `GameStateProvider` and handle redirect-back if the game state is missing.

| Task      | Description                                                                                                                                                                                                                                                               | Test                                                                                                                                       | Spec                                                                                                                                              |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------- |
| P1.S3.T1  | Convert `app/game/[gameId]/page.tsx` to a Client Component. Wrap contents in `<GameStateProvider>`. If `gameState` is `null` and socket is connected, show a loading skeleton (`<LoadingSkeleton>`); if socket is disconnected show `<ConnectionError>`.                  | Navigate directly to `/game/unknown` → skeleton renders briefly, then connection error (no game state).                                    | [P4.S6.T4](Phase4.md#step-46--visual--ux-polish), [P2.S4.T5](Phase2.md#step-24--game-state-synchronization)                                       |
| P1.S3.T2  | Once `gameState` is available, render `<GameLayout>` with `spaces`, `players`, `properties`, `currentPlayer`, `turnState`, and `isCurrentPlayersTurn` derived from `useGameState()`.                                                                                      | After starting a game from the lobby, the board renders with all 40 spaces and both players' tokens on Go.                                 | [P3A.S5.T1](Phase3A.md#step-3a5--turn-flow-ui), [P1B.S6.T1](Phase1B.md#step-1b6--mobile-responsive-layout)                                        |
| P1.S3.T3  | Render `<GameplayController>` inside the `GameLayout`, passing `gameState`, `localPlayerId` (from `useGameState().playerId`), and `emitAction` (from `useGameState().emitAction`).                                                                                        | The "Roll Dice" button appears for the active player; other players see no roll button.                                                    | [P3A.S1.T1](Phase3A.md#step-3a1--dice-rolling-flow), [P3A.S5.T2](Phase3A.md#step-3a5--turn-flow-ui)                                               |
| P1.S3.T4  | Wire the building managers: render `<BuildingManager>` and `<MortgageManager>` inside or alongside `GameplayController`, passing `gameState`, `localPlayerId`, and `emitAction`. Show them only when `turnState === PlayerAction` and it is the local player's turn.      | The "Build" and "Mortgage" panels are accessible during the correct turn phase and absent otherwise.                                       | [P3B.S3.T1](Phase3B.md#step-3b3--building-management-ui), [P3B.S4.T1](Phase3B.md#step-3b4--mortgage-management-ui)                                |
| P1.S3.T5  | Wire the trading UI: render `<TradeBuilder>` and `<IncomingTradeModal>` in the game page, showing `TradeBuilder` when the local player initiates a trade, and `IncomingTradeModal` when a `tradeProposed` socket event arrives for the local player.                      | Player A proposes a trade → Player B's screen shows the incoming trade modal with Accept/Reject/Counter buttons.                           | [P3B.S5.T7](Phase3B.md#step-3b5--trading-ui), [P3B.S5.T8](Phase3B.md#step-3b5--trading-ui)                                                        |
| P1.S3.T6  | Wire the `<AuctionPanel>` component: render it when `gameState.turnState === TurnState.Auction`. Pass current bid, bidder, and the `emitAction` handler for `AuctionBid` / `AuctionPass`.                                                                                 | Decline to buy a property → the auction panel appears for all players. Placing a bid updates the displayed high bid in all connected tabs. | [P3B.S1.T4](Phase3B.md#step-3b1--property-purchase--auction-ui), [P3B.S1.T6](Phase3B.md#step-3b1--property-purchase--auction-ui)                  |
| P1.S3.T7  | Render the `<ChatPanel>` in the game page (e.g. in the `GameLayout` sidebar), wired to `sendChatMessage` from `useGameSocket()`. Incoming `chatMessage` socket events (already handled by `GameStateProvider`) drive the message list from `useGameState().chatMessages`. | Send a chat message → message appears for all players in the room, including the spectating bankrupt player.                               | [P4.S5.T3](Phase4.md#step-45--in-game-chat), [P4.S5.T6](Phase4.md#step-45--in-game-chat)                                                          |
| P1.S3.T8  | Render the `<VictoryScreen>` overlay when `useGameState().gameOverData` is not null. Pass `winnerId` and `standings`. Wire the "Play Again" button to navigate back to `/lobby/${roomCode}` and "Leave" to navigate to `/`.                                               | One player goes bankrupt making only one player remain → the victory screen overlays the board. "Leave" returns to home.                   | [P4.S2.T2](Phase4.md#step-42--endgame--victory), [P4.S2.T6](Phase4.md#step-42--endgame--victory), [P4.S2.T7](Phase4.md#step-42--endgame--victory) |
| P1.S3.T9  | Wire the `<ReconnectionOverlay>` to the socket `disconnect`/`connect` events on the game page. On reconnect, call `reconnect(roomCode, playerId)` from `useGameSocket()` to restore game state.                                                                           | Kill the server mid-game → reconnection overlay appears. Restart the server → overlay disappears and game state is restored.               | [P2.S5.T3](Phase2.md#step-25--reconnection-handling), [P2.S5.T6](Phase2.md#step-25--reconnection-handling)                                        |
| P1.S3.T10 | Show the turn timer countdown in the UI (e.g. small label in `GameplayController`) using `useGameState().turnTimer`.                                                                                                                                                      | The seconds-remaining count updates every second while a turn is active.                                                                   | [P2.S6.T2](Phase2.md#step-26--turn-management-server)                                                                                             |
