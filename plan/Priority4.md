# Priority 4 — Test Coverage & Phase 5 Polish

Polish, optimize, and verify the application meets its quality targets. These tasks do not add new features but ensure correctness, performance, and responsiveness across all target environments.

**Prerequisite:** Priority 1 and Priority 3 complete (pages wired, E2E tests passing).

---

## Step 12 — Verify Unit Test Coverage Targets

Run coverage and close any gaps identified in [P6.S1](Phase6.md#step-61--unit-test-completion).

| Task       | Description                                                                                                                                                                      | Test                                                                                                                                                     | Spec                                                                                                                                                                           |
| ---------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| P4.S12.T1  | Run `pnpm --filter shared test -- --coverage` and inspect the HTML report. Identify any branch in `dice.ts` or `spaces.ts` under 100% branch coverage.                           | `coverage/index.html` for shared shows 100% branch coverage for `dice.ts` and `spaces.ts`.                                                               | [P6.S1.T1](Phase6.md#step-61--unit-test-completion), [P6.S1.T2](Phase6.md#step-61--unit-test-completion)                                                                       |
| P4.S12.T2  | Add missing tests for card effects: verify every card in both 16-card decks is exercised by a test, including the two "Advance to nearest Railroad" Chance cards.                | `pnpm --filter shared test -- --coverage` shows 100% branch coverage for `cards.ts`; filter Chance deck → count of `advanceNearestRailroad` effect is 2. | [P6.S1.T3](Phase6.md#step-61--unit-test-completion), [P1A.S5.T13c](Phase1A.md#step-1a5--card-system)                                                                           |
| P4.S12.T3  | Add missing tests for property management: auction with no bids (property remains unowned), hotel downgrade blocked by insufficient house supply.                                | Both scenarios have dedicated test cases and are reported as covered branches.                                                                           | [P6.S1.T4](Phase6.md#step-61--unit-test-completion), [P1A.S6.T9](Phase1A.md#step-1a6--property-management-logic), [P1A.S6.T21](Phase1A.md#step-1a6--property-management-logic) |
| P4.S12.T4  | Add missing tests for trading: counter-trade creates a new offer with swapped roles; original trade is marked 'countered'.                                                       | `counterTrade` test passes and is shown as a covered branch.                                                                                             | [P6.S1.T5](Phase6.md#step-61--unit-test-completion), [P1A.S7.T8](Phase1A.md#step-1a7--trading-logic)                                                                           |
| P4.S12.T5  | Add missing tests for jail: `useJailCard` where player holds GOOJF from Chance returns it to the Chance deck; GOOJF from Community Chest returns it to the Community Chest deck. | Both `useJailCard` scenarios pass; each card goes back to the correct deck.                                                                              | [P6.S1.T6](Phase6.md#step-61--unit-test-completion), [P6.S1.T13](Phase6.md#step-61--unit-test-completion), [P1A.S5.T19](Phase1A.md#step-1a5--card-system)                      |
| P4.S12.T6  | Add edge-case tests: player lands on Go exactly (awards $200); Chance "nearest railroad" from all three Chance positions (7→15, 22→25, 36→5 wraps and passes Go awarding $200).  | Six scenarios all pass with correct positions and cash deltas.                                                                                           | [P6.S1.T8](Phase6.md#step-61--unit-test-completion), [P6.S1.T11](Phase6.md#step-61--unit-test-completion)                                                                      |
| P4.S12.T7  | Add edge-case tests: Chance "nearest utility" from all three Chance positions (7→12, 22→28, 36→12 wraps and passes Go).                                                          | Six owned/unowned scenarios all pass.                                                                                                                    | [P6.S1.T12](Phase6.md#step-61--unit-test-completion)                                                                                                                           |
| P4.S12.T8  | Add edge-case test: Chance "Take a trip to Reading Railroad" drawn from Chance position 36 → player moves to position 5, passes Go, collects $200, then Railroad is resolved.    | Test passes: $200 awarded before railroad rent resolution.                                                                                               | [P6.S1.T15](Phase6.md#step-61--unit-test-completion), [P1A.S5.T16](Phase1A.md#step-1a5--card-system)                                                                           |
| P4.S12.T9  | Add edge-case test: Chance card that triggers movement to another Chance/CC space → second card is drawn and resolved (chain of effects).                                        | Test passes: two-card chain resolves completely in one turn.                                                                                             | [P6.S1.T16](Phase6.md#step-61--unit-test-completion), [P1A.S5.T21](Phase1A.md#step-1a5--card-system)                                                                           |
| P4.S12.T10 | Add edge-case test: CC "Street Repairs" at $40/house and $115/hotel rates vs Chance "General Repairs" at $25/$100 — verify the two decks use different rates.                    | One test for each deck; both pass with their respective rates.                                                                                           | [P6.S1.T17](Phase6.md#step-61--unit-test-completion), [P1A.S5.T12](Phase1A.md#step-1a5--card-system), [P1A.S5.T12a](Phase1A.md#step-1a5--card-system)                          |
| P4.S12.T11 | Add edge-case test: building auction when multiple players want to build and only limited houses remain.                                                                         | 2 players both want to build; only 1 house left → 1 auction conducted; winning player builds the house.                                                  | [P6.S1.T14](Phase6.md#step-61--unit-test-completion), [P1A.S6.T17a](Phase1A.md#step-1a6--property-management-logic)                                                            |
| P4.S12.T12 | Add edge-case test: declining player participates in and wins their own auction.                                                                                                 | Decliner bids, all others pass → decliner wins at their bid price (which may be less than face value).                                                   | [P6.S1.T18](Phase6.md#step-61--unit-test-completion), [P1A.S6.T3](Phase1A.md#step-1a6--property-management-logic)                                                              |
| P4.S12.T13 | Run full coverage check: `pnpm test -- --coverage` across all three packages. All changed modules must show ≥95% branch coverage.                                                | CI coverage step passes; coverage report shows no red branches in `engine/`, `game/`, or critical client hooks.                                          | [P6.S1](Phase6.md#step-61--unit-test-completion)                                                                                                                               |

---

## Step 13 — Canvas Render Optimization

The board re-renders the entire canvas on every React render cycle. Add dirty-checking so it only redraws when relevant board state actually changes.

| Task      | Description                                                                                                                                                                                              | Test                                                                                                                                                                                   | Spec                                                                                                             |
| --------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------- |
| P4.S13.T1 | Add a `useRef` to track the previous `players` array and `properties` array inside `PixiBoard.tsx`. Extract the draw call into a function only triggered when those refs differ from the current values. | Open the game page; open browser DevTools → Performance tab; record 30 seconds of idle game time (no actions taken); canvas `drawImage` calls should be absent (0 per second at idle). | [P5.S3.T8](Phase5.md#step-53--performance-optimization)                                                          |
| P4.S13.T2 | Ensure token movement animation still triggers redraws during the animation loop (use `requestAnimationFrame` only while `animatingTokensRef` has active entries) and stops when animation completes.    | Roll dice → token animates smoothly to new position → animation ends → canvas stops redrawing (verify via Performance tab).                                                            | [P5.S3.T8](Phase5.md#step-53--performance-optimization), [P1B.S4.T4](Phase1B.md#step-1b4--board-visual-elements) |

---

## Step 14 — Responsive Layout Verification

Test and fix the layout at each of the six target viewport widths defined in [P5.S2](Phase5.md#step-52--responsive-layout-refinement).

| Task      | Description                                                                                                                                                                         | Test                                                                                                       | Spec                                                                                                                 |
| --------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------- |
| P4.S14.T1 | Test at 320px width. Check for horizontal overflow (set `overflow: hidden` on `html` and inspect via DevTools → no scrollbar). Verify board is visible and dashboard is accessible. | Chrome DevTools at 320px: no horizontal scroll; board fills the screen; swipe-up drawer reveals dashboard. | [P5.S2.T1](Phase5.md#step-52--responsive-layout-refinement)                                                          |
| P4.S14.T2 | Test at 375px width (iPhone SE).                                                                                                                                                    | All game actions reachable; no content clipped; board and bottom drawer usable.                            | [P5.S2.T2](Phase5.md#step-52--responsive-layout-refinement)                                                          |
| P4.S14.T3 | Test at 414px width (larger phones).                                                                                                                                                | Proportions look correct; no wasted whitespace around the board.                                           | [P5.S2.T3](Phase5.md#step-52--responsive-layout-refinement)                                                          |
| P4.S14.T4 | Test at 768px width (tablet portrait).                                                                                                                                              | Board and dashboard both visible without scrolling; no overlapping elements.                               | [P5.S2.T4](Phase5.md#step-52--responsive-layout-refinement)                                                          |
| P4.S14.T5 | Test at 1024px width (tablet landscape / small desktop).                                                                                                                            | Full sidebar layout; board and dashboard share the viewport; all buttons legible.                          | [P5.S2.T5](Phase5.md#step-52--responsive-layout-refinement)                                                          |
| P4.S14.T6 | Test at 1440px width (large desktop).                                                                                                                                               | Content is centered or appropriately constrained; no extreme stretching of the board or dashboard.         | [P5.S2.T6](Phase5.md#step-52--responsive-layout-refinement)                                                          |
| P4.S14.T7 | Verify landscape orientation on mobile: set DevTools to 667×375 (iPhone SE landscape). Board should be wider; dashboard accessible.                                                 | Board fills the wider dimension; no important UI element hidden off-screen.                                | [P5.S2.T7](Phase5.md#step-52--responsive-layout-refinement)                                                          |
| P4.S14.T8 | Audit all interactive elements at 375px for minimum 44×44px touch target size. Use DevTools → Accessibility tab or a ruler overlay. Fix any that are smaller.                       | No button, link, or form control has a clickable area smaller than 44×44px at 375px viewport.              | [P5.S1.T6](Phase5.md#step-51--mobile-touch-optimization), [P1B.S6.T6](Phase1B.md#step-1b6--mobile-responsive-layout) |

---

## Step 15 — Bundle Size Analysis

| Task      | Description                                                                                                                                                                                                          | Test                                                                                                                                             | Spec                                                                                                             |
| --------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------ | ---------------------------------------------------------------------------------------------------------------- |
| P4.S15.T1 | Run `pnpm --filter client build` and check the build output summary for page sizes. Identify the largest chunks.                                                                                                     | `next build` output prints page sizes; note any page route with a first-load JS above 200 KB (gzipped).                                          | [P5.S3.T3](Phase5.md#step-53--performance-optimization)                                                          |
| P4.S15.T2 | If the game page bundle exceeds 200 KB gzipped, add `next/dynamic` with `ssr: false` to lazy-load `PixiBoard` (already partially done via `LazyBoard.tsx` — verify it is being used) and confirm the chunk is split. | Re-run `next build`; the game page first-load JS is ≤200 KB; a separate chunk for the board renderer is listed.                                  | [P5.S3.T3](Phase5.md#step-53--performance-optimization), [P5.S3.T4](Phase5.md#step-53--performance-optimization) |
| P4.S15.T3 | Verify sound assets are not loaded on page load. Open DevTools → Network → Media tab; load the game page and confirm no audio files are fetched until a game action fires.                                           | Zero audio network requests on initial page load; first dice roll triggers audio file fetch (or no fetch if lazy loaded through `useLazySound`). | [P5.S3.T5](Phase5.md#step-53--performance-optimization)                                                          |

---

## Step 16 — Cross-Browser Testing

| Task      | Description                                                                                                                                        | Test                                                                                                           | Spec                                                                                                   |
| --------- | -------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------ |
| P4.S16.T1 | Test full game flow in Chrome (latest 2 versions): create, join, play through buying a property, collecting rent, end game.                        | All flows complete without console errors or visual glitches in Chrome.                                        | [P5.S4.T1](Phase5.md#step-54--cross-browser-testing)                                                   |
| P4.S16.T2 | Test full game flow in Firefox (latest 2 versions).                                                                                                | All flows complete without console errors. WebSocket connects correctly.                                       | [P5.S4.T2](Phase5.md#step-54--cross-browser-testing)                                                   |
| P4.S16.T3 | Test full game flow in Safari (latest 2 versions). Pay attention to WebSocket behaviour and canvas rendering.                                      | All flows complete; WebSocket upgrade succeeds (verify in Network tab); board renders identically to Chrome.   | [P5.S4.T3](Phase5.md#step-54--cross-browser-testing)                                                   |
| P4.S16.T4 | Test full game flow in Edge (latest 2 versions).                                                                                                   | All flows complete without console errors.                                                                     | [P5.S4.T4](Phase5.md#step-54--cross-browser-testing)                                                   |
| P4.S16.T5 | Test on iOS Safari (physical device or Simulator): touch interactions, pinch-to-zoom on board, WebSocket stability.                                | Game is playable; pinch zooms the board (not the browser viewport); WebSocket stays connected for 10+ minutes. | [P5.S4.T5](Phase5.md#step-54--cross-browser-testing)                                                   |
| P4.S16.T6 | Test on Android Chrome (physical device or emulator): touch interactions, swipe drawer, WebSocket.                                                 | Game is playable; swipe-up drawer opens the dashboard; chat/action buttons work via touch.                     | [P5.S4.T6](Phase5.md#step-54--cross-browser-testing)                                                   |
| P4.S16.T7 | Run the Playwright E2E suite using all three browser targets defined in `playwright.config.ts` (Chromium, Firefox, WebKit): `npx playwright test`. | All 16 E2E scenarios pass across all three browser projects.                                                   | [P5.S4.T7](Phase5.md#step-54--cross-browser-testing), [P6.S3](Phase6.md#step-63--e2e-tests-playwright) |
