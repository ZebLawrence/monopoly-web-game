# Priority 5 — Production Hardening

Final production-readiness tasks: observability, SSL, README hygiene, and load validation. None of these block gameplay but all are required before a public launch.

**Prerequisite:** Priority 3 complete (Docker stack working, E2E tests passing).

---

## Step 17 — README Badge

| Task      | Description                                                                                                                                                                            | Test                                                                                          | Spec                                                      |
| --------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------- | --------------------------------------------------------- |
| P5.S17.T1 | Add a CI status badge to the root `README.md` (or `plan/README.md`) using the GitHub Actions badge URL format: `https://github.com/<owner>/<repo>/actions/workflows/ci.yml/badge.svg`. | The badge renders in the GitHub repository UI and reflects the current CI status (green/red). | [P6.S4.T6](Phase6.md#step-64--cicd-pipeline-finalization) |

---

## Step 18 — Error Tracking (Sentry)

| Task      | Description                                                                                                                                                                                                                               | Test                                                                                                                                                                                    | Spec                                                 |
| --------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------- |
| P5.S18.T1 | Create a Sentry project (or use an existing DSN). Add `SENTRY_DSN` to both `server/.env.example` and `client/.env.example`.                                                                                                               | Both `.env.example` files list `SENTRY_DSN=` with a comment describing where to find the value.                                                                                         | [P6.S5.T7](Phase6.md#step-65--production-deployment) |
| P5.S18.T2 | Install `@sentry/node` in the server package and initialise it in `server/src/index.ts` before routes are registered. Use `Sentry.init({ dsn: process.env.SENTRY_DSN })`. Add Sentry error handler middleware after all routes.           | Throw a deliberate `throw new Error('test-sentry')` in the `/health` handler (temporarily) → error appears in the Sentry dashboard within 30 seconds. Remove the test throw afterwards. | [P6.S5.T7](Phase6.md#step-65--production-deployment) |
| P5.S18.T3 | Install `@sentry/nextjs` in the client package. Run `npx @sentry/wizard@latest -i nextjs` or manually add `sentry.client.config.ts`, `sentry.server.config.ts`, and `sentry.edge.config.ts` with the project DSN.                         | Trigger a client-side error (e.g. visit a page that throws in SSR) → error captured in Sentry under the client project.                                                                 | [P6.S5.T7](Phase6.md#step-65--production-deployment) |
| P5.S18.T4 | Add Sentry environment tagging (`environment: process.env.NODE_ENV`) and release tagging (`release: process.env.GIT_SHA`) to both initialisations. Pass `GIT_SHA` as an environment variable in the Docker Compose file and CI workflows. | Sentry events show the correct environment (`development`, `production`) and a release identifier.                                                                                      | [P6.S5.T7](Phase6.md#step-65--production-deployment) |

---

## Step 19 — WebSocket Latency Monitoring

| Task      | Description                                                                                                                                                                                 | Test                                                                                                                        | Spec                                                                                                        |
| --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------- |
| P5.S19.T1 | Add server-side timing middleware in `server/src/socket/handlers.ts`: record `Date.now()` when a `gameAction` is received and again after `stateUpdate` is emitted; log the delta.          | A structured log line such as `{"event":"stateUpdate","latencyMs":12}` appears in the server console for every game action. | [P6.S5.T8](Phase6.md#step-65--production-deployment)                                                        |
| P5.S19.T2 | Expose an aggregated latency metric endpoint `GET /metrics` on the server that returns a JSON object with `p50`, `p95`, and `p99` latency values computed from a rolling 1000-event window. | `curl http://localhost:3001/metrics` returns `{"p50":8,"p95":25,"p99":60}` (values will vary; structure must match).        | [P6.S5.T8](Phase6.md#step-65--production-deployment)                                                        |
| P5.S19.T3 | Add the `/metrics` endpoint to the existing health check documentation in `docs/deployment-runbook.md` so operators know how to read it.                                                    | `docs/deployment-runbook.md` contains a section describing the `/metrics` endpoint and how to interpret p50/p95/p99 values. | [P6.S5.T8](Phase6.md#step-65--production-deployment), [P6.S5.T10](Phase6.md#step-65--production-deployment) |

---

## Step 20 — SSL/TLS Configuration

These tasks apply to the production deployment environment, not local development.

| Task      | Description                                                                                                                                                                                                                                               | Test                                                                                                                                                        | Spec                                                 |
| --------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------- |
| P5.S20.T1 | Configure the Next.js client hosting to serve over HTTPS. If deploying to Vercel/Netlify this is automatic. If self-hosting, provision a TLS certificate (e.g. Let's Encrypt via Certbot) and configure the reverse proxy (Nginx/Caddy) to terminate TLS. | `curl -I https://<production-domain>` returns `HTTP/2 200` with a valid certificate. `curl -I http://<production-domain>` returns a 301 redirect to HTTPS.  | [P6.S5.T4](Phase6.md#step-65--production-deployment) |
| P5.S20.T2 | Configure the Socket.IO server to accept WSS connections. Update `CLIENT_ORIGIN` environment variable to the production HTTPS URL. If behind a reverse proxy, ensure the proxy forwards the `Upgrade` header to allow WebSocket connections.              | Open browser DevTools → Network → WS tab on the production domain; the WebSocket connection shows `wss://` in the URL and status 101 (Switching Protocols). | [P6.S5.T4](Phase6.md#step-65--production-deployment) |
| P5.S20.T3 | Update `client/.env.example` and `docker-compose.yml` comments to note that `NEXT_PUBLIC_SERVER_URL` must use `https://` and `NEXT_PUBLIC_WS_URL` must use `wss://` in production.                                                                        | Both files contain a comment explaining the required protocol scheme for production.                                                                        | [P6.S5.T4](Phase6.md#step-65--production-deployment) |

---

## Step 21 — Load Testing

| Task      | Description                                                                                                                                                                                                                                                                                        | Test                                                                                                                                                                                                          | Spec                                                                                                        |
| --------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------- |
| P5.S21.T1 | Write a load test script using [Artillery](https://www.artillery.io/) or [k6](https://k6.io/) that simulates 200 Socket.IO connections organised into 100 rooms (2 clients per room). Each virtual user connects, creates or joins a room, then loops: roll dice, wait for state update, end turn. | Script runs without requiring manual intervention; all operations are scriptable via the Socket.IO protocol.                                                                                                  | [P6.S5.T9](Phase6.md#step-65--production-deployment)                                                        |
| P5.S21.T2 | Run the load test for 5 minutes against the production or staging server. Capture: p99 latency for `stateUpdate` events, error rate, and peak memory usage of the server process.                                                                                                                  | All 100 rooms function correctly throughout the test run. p99 `stateUpdate` latency stays under 200 ms. Error rate is 0%. Server memory usage does not grow unboundedly (delta < 50 MB from start to finish). | [P6.S5.T9](Phase6.md#step-65--production-deployment)                                                        |
| P5.S21.T3 | Record the load test results (tool used, command, environment, summary metrics) in `docs/deployment-runbook.md` under a "Load Testing" section.                                                                                                                                                    | The runbook section exists and a developer can reproduce the test by following the documented steps.                                                                                                          | [P6.S5.T9](Phase6.md#step-65--production-deployment), [P6.S5.T10](Phase6.md#step-65--production-deployment) |
