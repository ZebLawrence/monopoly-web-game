# Priority 3 — Docker & Missing Infrastructure

These tasks restore full Docker Compose support (currently broken due to a missing `client/Dockerfile`) and confirm the existing E2E test suite passes against the wired application from Priority 1.

**Prerequisite:** Priority 1 complete (pages are wired and the game is navigable).

---

## Step 10 — Create the Client Dockerfile

`docker-compose.yml` references `client/Dockerfile` but the file does not exist, so `docker compose up` currently fails with "failed to solve: failed to read dockerfile". The server's Dockerfile (`server/Dockerfile`) can be used as the model.

| Task      | Description                                                                                                                                                                                                       | Test                                                                                                                                                                         | Spec                                                                                                       |
| --------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------- |
| P3.S10.T1 | Create `client/Dockerfile` with a `base` stage: `FROM node:20-alpine`, enable corepack, `corepack prepare pnpm@10 --activate`, set `WORKDIR /app`.                                                                | `docker build -f client/Dockerfile .` reaches the base stage without error.                                                                                                  | [P6.S5.T1](Phase6.md#step-65--production-deployment)                                                       |
| P3.S10.T2 | Add a `deps` stage that copies `pnpm-lock.yaml`, `pnpm-workspace.yaml`, root `package.json`, `shared/package.json`, and `client/package.json`, then runs `pnpm install --frozen-lockfile`.                        | The deps stage completes and `node_modules` is populated inside the build layer.                                                                                             | [P6.S5.T1](Phase6.md#step-65--production-deployment)                                                       |
| P3.S10.T3 | Add a `build` stage that copies `shared/` and `client/` source, runs `pnpm --filter shared build` and then `pnpm --filter client build` (`next build`).                                                           | The build stage completes; a `.next` directory is created inside the layer.                                                                                                  | [P6.S5.T1](Phase6.md#step-65--production-deployment)                                                       |
| P3.S10.T4 | Add a `production` stage: minimal `node:20-alpine` image, copy compiled `.next`, `public/`, `node_modules`, set `ENV NODE_ENV=production PORT=3000`, expose port 3000, `CMD ["node_modules/.bin/next", "start"]`. | `docker build -f client/Dockerfile . --target production` completes without error and the final image is under 500 MB.                                                       | [P6.S5.T1](Phase6.md#step-65--production-deployment)                                                       |
| P3.S10.T5 | Set the `NEXT_PUBLIC_SERVER_URL` build arg in `docker-compose.yml` under the `client` service so it is baked into the Next.js build at `docker compose build` time.                                               | After `docker compose up`, open `http://localhost:3000` → the client connects to the server at `http://localhost:3001` without CORS or connection errors.                    | [P6.S5.T3](Phase6.md#step-65--production-deployment)                                                       |
| P3.S10.T6 | Run `docker compose up --build` from the repo root and verify all three services start: Redis on :6379, server on :3001, client on :3000.                                                                         | `docker compose ps` shows all three services as `running`; `curl http://localhost:3001/health` returns `{"status":"ok"}`; `curl http://localhost:3000` returns an HTML page. | [P6.S5.T1](Phase6.md#step-65--production-deployment), [P6.S5.T2](Phase6.md#step-65--production-deployment) |
| P3.S10.T7 | Verify the full create-join-play flow works against the Dockerised stack (no local `pnpm dev`).                                                                                                                   | Open `http://localhost:3000` in two browser tabs; create a game in tab 1; join in tab 2; start the game; roll dice → token moves.                                            | [P6.S5.T3](Phase6.md#step-65--production-deployment)                                                       |

---

## Step 11 — Run and Fix E2E Tests

`e2e/game.spec.ts` is 729 lines covering 16 scenarios but all tests will fail until Priority 1 is complete. Run the suite, triage failures, and fix each one.

| Task       | Description                                                                                                                                                                                                  | Test                                                                                                                    | Spec                                                      |
| ---------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ----------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------- |
| P3.S11.T1  | Start the full dev stack (`pnpm dev` or `docker compose up`) and run `npx playwright test --ui` to see the initial failure list.                                                                             | Playwright UI opens; tests are listed; you can see which ones time-out vs which have assertion errors.                  | [P6.S3.T1](Phase6.md#step-63--e2e-tests-playwright)       |
| P3.S11.T2  | Fix E2E: "Create game room and verify room code is displayed". Helper `hostCreatesRoom` looks for `[data-testid="create-game-form"]` and then `[data-testid="room-code"]`. Both must exist after Priority 1. | `P6.S3.T1` passes: navigating to home → clicking Create → lobby page shows a real 6-char room code.                     | [P6.S3.T1](Phase6.md#step-63--e2e-tests-playwright)       |
| P3.S11.T3  | Fix E2E: "Join game room with code and see player in waiting room".                                                                                                                                          | `P6.S3.T2` passes: second browser context enters the code → both players appear in the waiting room player list.        | [P6.S3.T2](Phase6.md#step-63--e2e-tests-playwright)       |
| P3.S11.T4  | Fix E2E: "Select tokens and start game".                                                                                                                                                                     | `P6.S3.T3` passes: players select distinct tokens → host clicks Start → game board renders in both tabs.                | [P6.S3.T3](Phase6.md#step-63--e2e-tests-playwright)       |
| P3.S11.T5  | Fix E2E: "Roll dice and see token move on board".                                                                                                                                                            | `P6.S3.T4` passes: Roll Dice clicked → dice values animate → token is on the correct space.                             | [P6.S3.T4](Phase6.md#step-63--e2e-tests-playwright)       |
| P3.S11.T6  | Fix E2E: "Land on unowned property and buy it".                                                                                                                                                              | `P6.S3.T5` passes: land on property → buy modal → Buy → ownership indicator appears.                                    | [P6.S3.T5](Phase6.md#step-63--e2e-tests-playwright)       |
| P3.S11.T7  | Fix E2E: "Land on owned property and pay rent".                                                                                                                                                              | `P6.S3.T6` passes: land on opponent's property → rent notification → both cash displays update.                         | [P6.S3.T6](Phase6.md#step-63--e2e-tests-playwright)       |
| P3.S11.T8  | Fix E2E: "Complete trade between two players".                                                                                                                                                               | `P6.S3.T7` passes: trade proposed → accepted → properties swap; Activity Feed event visible.                            | [P6.S3.T7](Phase6.md#step-63--e2e-tests-playwright)       |
| P3.S11.T9  | Fix E2E: "Build houses on a monopoly".                                                                                                                                                                       | `P6.S3.T8` passes: monopoly acquired → Build panel → house added → house sprite visible on board.                       | [P6.S3.T8](Phase6.md#step-63--e2e-tests-playwright)       |
| P3.S11.T10 | Fix E2E: "Go to jail and get out by paying fine".                                                                                                                                                            | `P6.S3.T9` passes: land on Go To Jail → in jail → Pay $50 → freed and can roll.                                         | [P6.S3.T9](Phase6.md#step-63--e2e-tests-playwright)       |
| P3.S11.T11 | Fix E2E: "Full game to completion (one player goes bankrupt)".                                                                                                                                               | `P6.S3.T10` passes: play until one player can't pay → bankruptcy declared → victory screen visible.                     | [P6.S3.T10](Phase6.md#step-63--e2e-tests-playwright)      |
| P3.S11.T12 | Fix E2E: "Reconnection — disconnect one player, reconnect, continue playing".                                                                                                                                | `P6.S3.T11` passes: socket killed → reconnection overlay → reconnect → game state restored → play continues.            | [P6.S3.T11](Phase6.md#step-63--e2e-tests-playwright)      |
| P3.S11.T13 | Fix E2E: "Mobile viewport (375px) full game flow playable".                                                                                                                                                  | `P6.S3.T12` passes: Playwright mobile viewport → all actions (roll, buy, end turn) accessible.                          | [P6.S3.T12](Phase6.md#step-63--e2e-tests-playwright)      |
| P3.S11.T14 | Fix E2E: "Chat messages sent and received between players".                                                                                                                                                  | `P6.S3.T13` passes: type and send a message → both tabs see it in the chat panel.                                       | [P6.S3.T13](Phase6.md#step-63--e2e-tests-playwright)      |
| P3.S11.T15 | Fix E2E: "Decline property and participate in auction as the declining player".                                                                                                                              | `P6.S3.T14` passes: decline → auction panel appears → declining player successfully places a bid.                       | [P6.S3.T14](Phase6.md#step-63--e2e-tests-playwright)      |
| P3.S11.T16 | Fix E2E: "Draw a Chance/Community Chest card and see effect applied".                                                                                                                                        | `P6.S3.T15` passes: land on Chance → card animated → card text displayed → cash/position changes match the card effect. | [P6.S3.T15](Phase6.md#step-63--e2e-tests-playwright)      |
| P3.S11.T17 | Fix E2E: "Mortgage and unmortgage a property".                                                                                                                                                               | `P6.S3.T16` passes: click Mortgage → property dims; click Unmortgage → property restored at correct cost.               | [P6.S3.T16](Phase6.md#step-63--e2e-tests-playwright)      |
| P3.S11.T18 | Add E2E results upload to CI (already in `ci.yml` but verify it works end-to-end). Confirm `playwright-report/` artefact is uploaded on failure.                                                             | Intentionally break one E2E test → CI run uploads the Playwright HTML report as a job artifact.                         | [P6.S4.T2](Phase6.md#step-64--cicd-pipeline-finalization) |
